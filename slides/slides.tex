% ----------------------------------------------------------------------------------------------------------------------------------
% Backup Best Practices
%
% Build from the Vagrant VM:
% cd /talk/slides && make -f /template/Makefile
% ----------------------------------------------------------------------------------------------------------------------------------
\def\mytitle{Backup Best Practices (Draft)}
\def\mysubject{}
\def\myevent{}
\def\myauthor{David Steele}
\def\myemail{}
\def\mydate{November 16, 2017}

% Suppres navigation bars
\def\mysuppressnav{}

% Include Crunchy template
\def\mytemplatepath{/template/}
\input{\mytemplatepath crunchy-template.tex}

% Agenda
\begin{frame}
    \frametitle{Agenda}
    \tableofcontents
\end{frame}

\section{Why and How to Backup}

??? How easy is it to use pgBackRest
??? Write recovery.conf file
??? Use backrest as examples of BP.
??? Configurations
??? Consistent setups
??? Don't backup to standby
??? Versions must match

??? Best practices for Crunchy

\begin{frame}
    \frametitle{Why Backup?}

    \begin{itemize}
        \item Hardware Failure:

        \begin{itemize}
            \item No amount of redundancy can prevent it.\pause
        \end{itemize}

        \item Replication:

        \begin{itemize}
            \item WAL archive for when async streaming gets behind.\pause
            \item
            \item Sync replica from backup instead of master.\pause
        \end{itemize}

        \item Corruption:

        \begin{itemize}
            \item Can be caused by hardware or software.\pause
            \item Detection is, of course, a challenge.
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Why Backup?}

    \begin{itemize}
        \item Accidents:

        \begin{itemize}
            \item So you dropped a table?\pause
            \item Deleted your most important account?\pause
        \end{itemize}

        \item Development:

        \begin{itemize}
            \item No more realistic data than production!\pause
            \item May not be practical due to size / privacy issues.\pause
        \end{itemize}

        \item Reporting:

        \begin{itemize}
            \item Use backups to standup an independent reporting server.\pause
            \item Recover important data that was removed on purpose.
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Schr\"{o}dingerâ€™s Backup}

    \Large The state of any backup is unknown until a restore is attempted.
\end{frame}

\begin{frame}
    \frametitle{Making Backups Useful}

    \begin{itemize}
        \item Find a way to use your backups

        \begin{itemize}
            \item Syncing / New Replicas
            \item Offline reporting
            \item Offline data archiving
            \item Development
        \end{itemize}

        \item Unused code paths will not work when you need them unless they are tested

        \begin{itemize}
            \item Regularly scheduled automated failover using backups to restore the old primary
            \item Regularly scheduled disaster recovery (during a maintenance window if possible) to test restore techniques
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{How to Backup?}

    \begin{itemize}
        \item pg\_dump

        \item pg\_basebackup

        \item pgBackRest!
    \end{itemize}
\end{frame}

\section{Best Practices}

\begin{frame}
    \frametitle{Backup Types}

    \begin{itemize}
        \item Full

        A complete copy of the database.

        \item Incremental

        Copy only files that have changed since the last backup.

        \item Differential

        Like an incremental, but only copy files that have changed since the last \textbf{full} backup.
    \end{itemize}
\end{frame}

\begin{frame}[fragile]
    \frametitle{Backup Retention}

    A good default retention is:

    \begin{quote}\begin{verbatim}
retention-full=5
retention-diff=3
    \end{verbatim}\end{quote}\vspace{-1em}

    Run the full backup once a week and differential backups the other six days.
    \vspace{1em}
    With this schedule there will always be at least four weeks of backups to work with.
\end{frame}

\begin{frame}[fragile]
    \frametitle{Backup Retention}

    A minimal retention is:

    \begin{quote}\begin{verbatim}
retention-full=2
retention-diff=1
    \end{verbatim}\end{quote}\vspace{-1em}

    Run the full backup once a week and differentials the other six days.
    \vspace{1em}
    With this schedule there will always be at least a week of backups to work with.  This not enough for many use cases and this retention should be considered "degraded" and only used temporarily until more space is allocated.
\end{frame}

\begin{frame}
    \frametitle{Checksums}

    When initializing a new cluster always specify the \texttt{-k} option.

    This will enable page checksums which pgBackRest will verify on every backup.  If corruption is detected early it can often be corrected.

    If corruption is detected, don't panic!  As long as older non-corrupted backups exist there are options.
\end{frame}

\begin{frame}
    \frametitle{Restore}

    Multi-processing can lead to dramatic reductions in restore time and network utilization.  Use the \texttt{--delta} option with the \texttt{restore} command when time is of the essence.

    Another system if possible (try to make a copy - at least pg_xlog).
    Config files may be part of the backup.

    Double-check where you are restoring.  pgBackRest will refuse to overwrite a \textit{running} cluster but it will happily overwrite a shutdown down cluster when \texttt{--delta} is used.
\end{frame}

\begin{frame}
    \frametitle{Archiving}

    Asynchronous parallel archiving allows compression and transfer to be offloaded to another process which maintains continuous connections to the remote server, improving throughput significantly.\\\pause
    \vspace{1em}

    Archive timeout

    Create file to reserve space.

    Space!

    A critical feature for databases with extremely high write volume.
\end{frame}

\begin{frame}
    \frametitle{Backup from Standby}

    \begin{itemize}
        \item Backup is started on master.\pause
        \item Backup starts when replay location on standby reaches start backup location.\pause
        \item Reduces load on master because replicated files are copied from the standby.
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Don't Panic!}

    A failed backup should not be cause for panic.  Ideally, there are a number of backups that can be used for a restore.\\
    \vspace{1em}
    Remember:\\
    \vspace{1em}
    Backup + WAL = Recoverable Database\\
    \textbf{OLDER} Backup + WAL = Recoverable Database
\end{frame}

\begin{frame}
    \frametitle{Now Panic!}

    If Backup + WAL = Recoverable Database, then then a failing archive command means you won't be able to do a complete restore even if the backups have been successful.\\
    \vspace{1em}
    Worse, the disk could fill up and cause PostgreSQL to panic and stop.\\
    \vspace{1em}
    Even if the replica is up to date it is not a backup!
\end{frame}

\section{Questions?}

\begin{frame}
    \frametitle{Questions?}

    website: \url{http://www.pgbackrest.org}\\
    \vspace{1em}
    email: \href{mailto:david@pgbackrest.org}{david@pgbackrest.org} \\
    email: \href{mailto:david@crunchydata.com}{david@crunchydata.com}\\
    \vspace{1em}
    releases: \url{https://github.com/pgbackrest/pgbackrest/releases}\\
    \vspace{1em}
    slides \& demo: \url{https://github.com/dwsteele/conference/releases}\\
\end{frame}

% End document
\end{document}
