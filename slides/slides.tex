% ----------------------------------------------------------------------------------------------------------------------------------
% Backup Best Practices
%
% Build from the Vagrant VM:
% cd /talk/slides && make -f /template/Makefile
% ----------------------------------------------------------------------------------------------------------------------------------
\def\mytitle{Backup Best Practices (Draft)}
\def\mysubject{}
\def\myevent{}
\def\myauthor{David Steele}
\def\myemail{}
\def\mydate{November 16, 2017}

% Suppres navigation bars
\def\mysuppressnav{}

% Include Crunchy template
\def\mytemplatepath{/template/}
\input{\mytemplatepath crunchy-template.tex}

% Agenda
\begin{frame}
    \frametitle{Agenda}
    \tableofcontents
\end{frame}

\section{Why and How to Backup}

\begin{frame}
    \frametitle{Why Backup?}

    \begin{itemize}
        \item Hardware Failure:

        \begin{itemize}
            \item No amount of redundancy can prevent it.\pause
        \end{itemize}

        \item Replication:

        \begin{itemize}
            \item WAL archive for when async streaming gets behind.\pause
            \item Sync replica from backup instead of master.\pause
        \end{itemize}

        \item Corruption:

        \begin{itemize}
            \item Can be caused by hardware or software.\pause
            \item Detection is, of course, a challenge.
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Why Backup?}

    \begin{itemize}
        \item Accidents:

        \begin{itemize}
            \item So you dropped a table?\pause
            \item Deleted your most important account?\pause
        \end{itemize}

        \item Development:

        \begin{itemize}
            \item No more realistic data than production!\pause
            \item May not be practical due to size / privacy issues.\pause
        \end{itemize}

        \item Reporting:

        \begin{itemize}
            \item Use backups to standup an independent reporting server.\pause
            \item Recover important data that was removed on purpose.
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Schr\"{o}dingerâ€™s Backup}

    The state of any backup is unknown until a restore is attempted.
\end{frame}

\begin{frame}
    \frametitle{Making Backups Useful}

    \begin{itemize}
        \item Find a way to use your backups

        \begin{itemize}
            \item Syncing / New Replicas
            \item Offline reporting
            \item Offline data archiving
            \item Development
        \end{itemize}

        \item Unused code paths will not work when you need them unless they are tested

        \begin{itemize}
            \item Regularly scheduled automated failover using backups to restore the old primary
            \item Regularly scheduled disaster recovery (during a maintenance window if possible) to test restore techniques
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{How to Backup?}

    \begin{itemize}
        \item pg\_dump

        \item pg\_basebackup

        \item pgBackRest!
    \end{itemize}
\end{frame}

\section{Best Practices}

\begin{frame}
    \frametitle{Backup Types}

    \begin{itemize}
        \item Full

        A complete copy of the database.

        \item Incremental

        Copy only files that have changed since the last backup.

        \item Differential

        Like an incremental, but only copy files that have changed since the last \textbf{full} backup.
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Checksums}

    When initializing a new cluster always specify the \texttt{-k} option.

    This will enable page checksums which pgBackRest will verify on every backup.
\end{frame}

\begin{frame}
    \frametitle{Delta Restore}

    \begin{itemize}
        \item Backup manifest contains checksum and size for every file.\pause
        \item On delta restore all files not present in the backup or with a different size are removed from PGDATA.\pause
        \item The remaining files are checksummed and only files with a checksum mismatch are restored.\pause
        \item Multi-processing can lead to dramatic reductions in restore time and network utilization.
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Parallel Archiving}

    \begin{itemize}
        \item Dedicated commands are included for both pushing WAL to the archive and retrieving WAL from the archive.\pause
        \item Push command automatically detects WAL segments that are pushed multiple times and de-duplicates when the segment is identical, otherwise an error is raised.\pause
        \item Push and get commands both ensure that the database and repository match by comparing PostgreSQL versions and system identifiers to prevent misconfiguration.\pause

        \item Asynchronous parallel archiving allows compression and transfer to be offloaded to another process which maintains continuous connections to the remote server, improving throughput significantly.\pause

            \begin{itemize}
                \item Critical feature for databases with extremely high write volume.
            \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}
    \frametitle{Backup from Standby}

    \begin{itemize}
        \item Backup is started on master.\pause
        \item Backup starts when replay location on standby reaches start backup location.\pause
        \item Reduces load on master because replicated files are copied from the standby.
    \end{itemize}
\end{frame}

\section{Questions?}

\begin{frame}
    \frametitle{Questions?}

    website: \url{http://www.pgbackrest.org}\\
    \vspace{1em}
    email: \href{mailto:david@pgbackrest.org}{david@pgbackrest.org} \\
    email: \href{mailto:david@crunchydata.com}{david@crunchydata.com}\\
    \vspace{1em}
    releases: \url{https://github.com/pgbackrest/pgbackrest/releases}\\
    \vspace{1em}
    slides \& demo: \url{https://github.com/dwsteele/conference/releases}\\
\end{frame}

% End document
\end{document}
