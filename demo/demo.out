pgBackRest Demo
===============

---------------------------
Setup the cluster and repo:
---------------------------

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast > /dev/null

CREATE DB DIR: mkdir db

CREATE CLUSTER: /usr/lib/postgresql/9.4/bin/initdb -D db -A trust > /dev/null

START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

CREATE TABLE: echo "create table test (message text)" | psql postgres
CREATE TABLE

SHOW CONF: cat /etc/pg_backrest.conf
[global:general]
repo-path=/home/vagrant/repo

[main]
db-path=/home/vagrant/db

CREATE REPO: mkdir repo

----------------------
Perform a full backup:
----------------------

BACKUP TYPE=FULL: pg_backrest --stanza=main --type=full backup

DB SIZE: du -sh db
52M	db

SHOW BACKUP: ls -lah repo/backup/main
total 16K
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 .
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 ..
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 20151111-201045F
-rw-r----- 1 vagrant vagrant 1.5K Nov 11 20:10 backup.info
lrwxrwxrwx 1 vagrant vagrant   16 Nov 11 20:10 latest -> 20151111-201045F

BACKUP SIZE: du -sh repo/backup/main
5.2M	repo/backup/main

-----------------------------------
Show archive after the full backup:
-----------------------------------

SHOW ARCHIVE: ls -lah repo/archive/main/9.4-1/0000000100000000
total 1.8M
drwxr-x--- 2 vagrant vagrant 4.0K Nov 11 20:10 .
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 ..
-rw-r----- 1 vagrant vagrant 1.8M Nov 11 20:10 000000010000000000000001-b6ee99f9232c841e2a6ec53f4f2604698446ed25.gz
-rw-r----- 1 vagrant vagrant  330 Nov 11 20:10 000000010000000000000002.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Nov 11 20:10 000000010000000000000002-f661a7fff72ccfed93df648f5dcc074e3314bbb8.gz

ARCHIVE SIZE: du -sh repo/archive/main/9.4-1
1.8M	repo/archive/main/9.4-1

------------------------------
Perform a differential backup:
------------------------------

BACKUP TYPE=DIFF: pg_backrest --stanza=main --type=diff backup

DB SIZE: du -sh db
68M	db

SHOW BACKUP: ls -lah repo/backup/main
total 20K
drwxr-x--- 4 vagrant vagrant 4.0K Nov 11 20:10 .
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 ..
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 20151111-201045F
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 20151111-201045F_20151111-201048D
-rw-r----- 1 vagrant vagrant 2.7K Nov 11 20:10 backup.info
lrwxrwxrwx 1 vagrant vagrant   33 Nov 11 20:10 latest -> 20151111-201045F_20151111-201048D

BACKUP SIZE: du -sh repo/backup/main
5.3M	repo/backup/main

-------------------------------------------
Show archive after the differential backup:
-------------------------------------------

SHOW ARCHIVE: ls -lah repo/archive/main/9.4-1/0000000100000000
total 1.8M
drwxr-x--- 2 vagrant vagrant 4.0K Nov 11 20:10 .
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 ..
-rw-r----- 1 vagrant vagrant 1.8M Nov 11 20:10 000000010000000000000001-b6ee99f9232c841e2a6ec53f4f2604698446ed25.gz
-rw-r----- 1 vagrant vagrant  330 Nov 11 20:10 000000010000000000000002.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Nov 11 20:10 000000010000000000000002-f661a7fff72ccfed93df648f5dcc074e3314bbb8.gz
-rw-r----- 1 vagrant vagrant  330 Nov 11 20:10 000000010000000000000003.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Nov 11 20:10 000000010000000000000003-c6a30f1177741fd711c86d8a8fdc1e09853ca79f.gz

ARCHIVE SIZE: du -sh repo/archive/main/9.4-1
1.8M	repo/archive/main/9.4-1

-----------------------------
Release time - take a backup:
-----------------------------

BACKUP TYPE=INCR: pg_backrest --stanza=main --type=incr backup

SHOW BACKUP: ls -lah repo/backup/main
total 24K
drwxr-x--- 5 vagrant vagrant 4.0K Nov 11 20:10 .
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 ..
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 20151111-201045F
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 20151111-201045F_20151111-201048D
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 20151111-201045F_20151111-201051I
-rw-r----- 1 vagrant vagrant 3.9K Nov 11 20:10 backup.info
lrwxrwxrwx 1 vagrant vagrant   33 Nov 11 20:10 latest -> 20151111-201045F_20151111-201051I

-----------------------------------
Release time - set a restore point:
-----------------------------------

INSERT BEFORE MESSAGE: echo "insert into test values ('before release')" | psql postgres
INSERT 0 1

CREATE RESTORE POINT: echo "select pg_create_restore_point('release')" | psql postgres
 pg_create_restore_point 
-------------------------
 0/5002098
(1 row)


--------------------
Perform the release:
--------------------

INSERT AFTER MESSAGE: echo "update test set message = 'after release'" | psql postgres
UPDATE 1

-------------------------------------------------
QA says the release is no good - please rollback:
-------------------------------------------------

RESTORE TYPE=NAME TARGET=release: pg_backrest --stanza=main --type=name --target=release --delta restore
2015-11-11 20:10:51.746 T00  ERROR: [113]: unable to restore while Postgres is running

----------------------------------------
Forgot to stop the database - try again:
----------------------------------------

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast > /dev/null

RESTORE TYPE=NAME TARGET=release: pg_backrest --stanza=main --type=name --target=release --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pg_backrest --stanza=main archive-get %f "%p"'
recovery_target_name = 'release'

-------------------------------------------
Start the database and verify the recovery:
-------------------------------------------

START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
    message     
----------------
 before release
(1 row)


SHOW NEW TIMELINE: ls -lah repo/archive/main/9.4-1
total 16K
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 .
drwxr-x--- 3 vagrant vagrant 4.0K Nov 11 20:10 ..
drwxr-x--- 2 vagrant vagrant 4.0K Nov 11 20:10 0000000100000000
-rw-r----- 1 vagrant vagrant   39 Nov 11 20:10 00000002.history

-------------------------------------------------------------
App is started and important data is written to the database:
-------------------------------------------------------------

INSERT AFTER MESSAGE: echo "update test set message = 'very important update'" | psql postgres
UPDATE 1

------------------------------------------------------------------
QA made a mistake, the release is good!  Please undo the rollback:
------------------------------------------------------------------

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast > /dev/null

RESTORE TYPE=DEFAULT: pg_backrest --stanza=main --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pg_backrest --stanza=main archive-get %f "%p"'

START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
    message    
---------------
 after release
(1 row)


--------------------------------------------------------------
Uh oh - what about the 'very important update' that happened?:
--------------------------------------------------------------

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast > /dev/null

RESTORE TYPE=DEFAULT TIMELINE=2: pg_backrest --stanza=main --target-timeline=2 --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pg_backrest --stanza=main archive-get %f "%p"'
recovery_target_timeline = '2'

START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
        message        
-----------------------
 very important update
(1 row)


----------------
Show basic info:
----------------

INFO OUTPUT=TEXT: pg_backrest --stanza=main info
stanza main
    status: ok
    oldest backup label: 20151111-201045F
    oldest backup timestamp: 2015-11-11 20:10:37
    latest backup label: 20151111-201045F_20151111-201051I
    latest backup timestamp: 2015-11-11 20:10:48

--------------------------
Show exhaustive JSON info:
--------------------------

INFO OUTPUT=JSON: pg_backrest --stanza=main --output=json info
[
    {
        "backup" : [
            {
                "archive" : {
                    "start" : "000000010000000000000002",
                    "stop" : "000000010000000000000002"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.85"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 20370921,
                    "repository" : {
                        "delta" : 2502168,
                        "size" : 2502168
                    },
                    "size" : 20370921
                },
                "label" : "20151111-201045F",
                "prior" : null,
                "reference" : null,
                "timestamp" : {
                    "start" : 1447272637,
                    "stop" : 1447272645
                },
                "type" : "full"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000003",
                    "stop" : "000000010000000000000003"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.85"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8426,
                    "repository" : {
                        "delta" : 142253,
                        "size" : 2525988
                    },
                    "size" : 20370921
                },
                "label" : "20151111-201045F_20151111-201048D",
                "prior" : "20151111-201045F",
                "reference" : [
                    "20151111-201045F"
                ],
                "timestamp" : {
                    "start" : 1447272646,
                    "stop" : 1447272648
                },
                "type" : "diff"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000004",
                    "stop" : "000000010000000000000004"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.85"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8426,
                    "repository" : {
                        "delta" : 142273,
                        "size" : 2526008
                    },
                    "size" : 20370921
                },
                "label" : "20151111-201045F_20151111-201051I",
                "prior" : "20151111-201045F_20151111-201048D",
                "reference" : [
                    "20151111-201045F"
                ],
                "timestamp" : {
                    "start" : 1447272648,
                    "stop" : 1447272651
                },
                "type" : "incr"
            }
        ],
        "db" : [
            {
                "id" : "1",
                "system-id" : 6215988634759452993,
                "version" : "9.4"
            }
        ],
        "name" : "main",
        "status" : {
            "code" : 0,
            "message" : "ok"
        }
    }
]


Demo Complete!
