pgBackRest Demo

Setup the cluster and repo:

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast

CREATE DB DIR: mkdir db

CREATE CLUSTER: /usr/lib/postgresql/9.4/bin/initdb -D db -A trust
The files belonging to this database system will be owned by user "vagrant".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory db ... ok
creating subdirectories ... ok
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting dynamic shared memory implementation ... posix
creating configuration files ... ok
creating template1 database in db/base/1 ... ok
initializing pg_authid ... ok
initializing dependencies ... ok
creating system views ... ok
loading system objects' descriptions ... ok
creating collations ... ok
creating conversions ... ok
creating dictionaries ... ok
setting privileges on built-in objects ... ok
creating information schema ... ok
loading PL/pgSQL server-side language ... ok
vacuuming database template1 ... ok
copying template1 to template0 ... ok
copying template1 to postgres ... ok
syncing data to disk ... ok

Success. You can now start the database server using:

    /usr/lib/postgresql/9.4/bin/postgres -D db
or
    /usr/lib/postgresql/9.4/bin/pg_ctl -D db -l logfile start


START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

CREATE TABLE: echo "create table test (message text)" | psql postgres
CREATE TABLE

SHOW CONF: cat /etc/pg_backrest.conf
[global:general]
repo-path=/home/vagrant/repo

[main]
db-path=/home/vagrant/db

CREATE REPO: mkdir repo

[press enter]

Do a full backup:

BACKUP TYPE=FULL: pg_backrest --stanza=main --type=full backup

DB SIZE: du -sh db
52M	db

SHOW BACKUP: ls -lah repo/backup/main
total 16K
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 .
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 ..
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 20151029-113141F
-rw-r----- 1 vagrant vagrant 1.5K Oct 29 11:31 backup.info
lrwxrwxrwx 1 vagrant vagrant   16 Oct 29 11:31 latest -> 20151029-113141F

BACKUP SIZE: du -sh repo/backup/main
5.2M	repo/backup/main

BACKUP INFO: more repo/backup/main/backup.info
[backrest]
backrest-checksum="3785a34e61492e693b232204e1a3917893b7368d"
backrest-format=4
backrest-version="0.85"

[backup:current]
20151029-113141F={"backrest-format":4,"backrest-version":"0.85","backup-archive-start":"000000010000000000000002","backup-archive-stop":"000000010000000000000002","backup-info-repo-size":2502167,"backup-info-repo-size-delta":2502167,"backup-info-size":20370921,"backup-info-size-delta":20370921,"backup-timestamp-start":1446118292,"backup-timestamp-stop":1446118301,"backup-type":"full","db-id":1,"option-archive-check":true,"option-archive-copy":false,"option-compress":true,"option-hardlink":false,"option-start-stop":true}

[backup:history]
20151029-113141F={"backrest-format":4,"backrest-version":"0.85","backup-archive-start":"000000010000000000000002","backup-archive-stop":"000000010000000000000002","backup-info-repo-size":2502167,"backup-info-repo-size-delta":2502167,"backup-info-size":20370921,"backup-info-size-delta":20370921,"backup-timestamp-start":1446118292,"backup-timestamp-stop":1446118301,"backup-type":"full","db-id":1,"option-archive-check":true,"option-archive-copy":false,"option-compress":true,"option-hardlink":false,"option-start-stop":true}

[db]
db-catalog-version=201409291
db-control-version=942
db-id=1
db-system-id=6211030761463374229
db-version="9.4"

[db:history]
1={"db-catalog-version":201409291,"db-control-version":942,"db-system-id":6211030761463374229,"db-version":"9.4"}

[press enter]


SHOW ARCHIVE: ls -lah repo/archive/main/9.4-1/0000000100000000
total 1.8M
drwxr-x--- 2 vagrant vagrant 4.0K Oct 29 11:31 .
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 ..
-rw-r----- 1 vagrant vagrant 1.8M Oct 29 11:31 000000010000000000000001-9cca97005d7bc7b40d9bb821ac766e8b36c8a034.gz
-rw-r----- 1 vagrant vagrant  330 Oct 29 11:31 000000010000000000000002.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Oct 29 11:31 000000010000000000000002-062940223ed3fb81ac5ce963123428aeae6f20df.gz

ARCHIVE SIZE: du -sh repo/archive/main/9.4-1
1.8M	repo/archive/main/9.4-1

ARCHIVE INFO: more repo/archive/main/archive.info
[backrest]
backrest-checksum="b9350ff865563f8ba6a92b50bc59648fc21c1d34"
backrest-format=4
backrest-version="0.85"

[db]
db-id=1
db-system-id=6211030761463374229
db-version="9.4"

[db:history]
1={"db-id":6211030761463374229,"db-version":"9.4"}

[press enter]

Do a differential backup:

BACKUP TYPE=DIFF: pg_backrest --stanza=main --type=diff backup

DB SIZE: du -sh db
68M	db

SHOW BACKUP: ls -lah repo/backup/main
total 20K
drwxr-x--- 4 vagrant vagrant 4.0K Oct 29 11:31 .
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 ..
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 20151029-113141F
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 20151029-113141F_20151029-113144D
-rw-r----- 1 vagrant vagrant 2.7K Oct 29 11:31 backup.info
lrwxrwxrwx 1 vagrant vagrant   33 Oct 29 11:31 latest -> 20151029-113141F_20151029-113144D

BACKUP SIZE: du -sh repo/backup/main
5.3M	repo/backup/main

SHOW ARCHIVE: ls -lah repo/archive/main/9.4-1/0000000100000000
total 1.8M
drwxr-x--- 2 vagrant vagrant 4.0K Oct 29 11:31 .
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 ..
-rw-r----- 1 vagrant vagrant 1.8M Oct 29 11:31 000000010000000000000001-9cca97005d7bc7b40d9bb821ac766e8b36c8a034.gz
-rw-r----- 1 vagrant vagrant  330 Oct 29 11:31 000000010000000000000002.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Oct 29 11:31 000000010000000000000002-062940223ed3fb81ac5ce963123428aeae6f20df.gz
-rw-r----- 1 vagrant vagrant  330 Oct 29 11:31 000000010000000000000003.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Oct 29 11:31 000000010000000000000003-20ea4b9accea0f88fd14d16a8f8f432b9d8f68be.gz

ARCHIVE SIZE: du -sh repo/archive/main/9.4-1
1.8M	repo/archive/main/9.4-1

[press enter]

Release time - let's backup and set a restore point so we can rollback if needed:

BACKUP TYPE=INCR: pg_backrest --stanza=main --type=incr backup

SHOW BACKUP: ls -lah repo/backup/main
total 24K
drwxr-x--- 5 vagrant vagrant 4.0K Oct 29 11:31 .
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 ..
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 20151029-113141F
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 20151029-113141F_20151029-113144D
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 20151029-113141F_20151029-113147I
-rw-r----- 1 vagrant vagrant 3.9K Oct 29 11:31 backup.info
lrwxrwxrwx 1 vagrant vagrant   33 Oct 29 11:31 latest -> 20151029-113141F_20151029-113147I

INSERT BEFORE MESSAGE: echo "insert into test values ('before release')" | psql postgres
INSERT 0 1

CREATE RESTORE POINT: echo "select pg_create_restore_point('release')" | psql postgres
 pg_create_restore_point 
-------------------------
 0/5002098
(1 row)

DO THE RELEASE!

INSERT AFTER MESSAGE: echo "update test set message = 'after release'" | psql postgres
UPDATE 1

[press enter]

QA says the release is no good - please rollback:

RESTORE TYPE=NAME TARGET=release: pg_backrest --stanza=main --type=name --target=release --delta restore
2015-10-29 11:31:47.843 T00  ERROR: [113]: unable to restore while Postgres is running

[press enter]

Forgot to stop the database - try again:

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast

RESTORE TYPE=NAME TARGET=release: pg_backrest --stanza=main --type=name --target=release --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pg_backrest --stanza=main archive-get %f "%p"'
recovery_target_name = 'release'

START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
    message     
----------------
 before release
(1 row)


SHOW NEW TIMELINE: ls -lah repo/archive/main/9.4-1
total 16K
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 .
drwxr-x--- 3 vagrant vagrant 4.0K Oct 29 11:31 ..
drwxr-x--- 2 vagrant vagrant 4.0K Oct 29 11:31 0000000100000000
-rw-r----- 1 vagrant vagrant   39 Oct 29 11:31 00000002.history

SHOW NEW TIMELINE INFO: more repo/archive/main/9.4-1/00000002.history
1	0/5002098	at restore point "release"

INSERT AFTER MESSAGE: echo "update test set message = 'very important update'" | psql postgres
UPDATE 1

[press enter]

QA made a mistake, the release is good!  Please undo the rollback:

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast

RESTORE TYPE=DEFAULT: pg_backrest --stanza=main --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pg_backrest --stanza=main archive-get %f "%p"'

START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
    message    
---------------
 after release
(1 row)


[press enter]

Uh oh - what about the 'very important update' that happened?.  Rollback the undo of the rollback (probably best to do this on another system):

STOP CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl stop -D db -w -s -m fast

RESTORE TYPE=DEFAULT TIMELINE=2: pg_backrest --stanza=main --target-timeline=2 --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pg_backrest --stanza=main archive-get %f "%p"'
recovery_target_timeline = '2'

START CLUSTER: /usr/lib/postgresql/9.4/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pg_backrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
        message        
-----------------------
 very important update
(1 row)


[press enter]


INFO OUTPUT=TEXT: pg_backrest --stanza=main info
stanza main
    status: ok
    oldest backup label: 20151029-113141F
    oldest backup timestamp: 2015-10-29 11:31:32
    latest backup label: 20151029-113141F_20151029-113147I
    latest backup timestamp: 2015-10-29 11:31:44

[press enter]


INFO OUTPUT=JSON: pg_backrest --stanza=main --output=json info
[
    {
        "backup" : [
            {
                "archive" : {
                    "start" : "000000010000000000000002",
                    "stop" : "000000010000000000000002"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.85"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 20370921,
                    "repository" : {
                        "delta" : 2502167,
                        "size" : 2502167
                    },
                    "size" : 20370921
                },
                "label" : "20151029-113141F",
                "prior" : null,
                "reference" : null,
                "timestamp" : {
                    "start" : 1446118292,
                    "stop" : 1446118301
                },
                "type" : "full"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000003",
                    "stop" : "000000010000000000000003"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.85"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8426,
                    "repository" : {
                        "delta" : 142253,
                        "size" : 2525988
                    },
                    "size" : 20370921
                },
                "label" : "20151029-113141F_20151029-113144D",
                "prior" : "20151029-113141F",
                "reference" : [
                    "20151029-113141F"
                ],
                "timestamp" : {
                    "start" : 1446118301,
                    "stop" : 1446118304
                },
                "type" : "diff"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000004",
                    "stop" : "000000010000000000000004"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.85"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8426,
                    "repository" : {
                        "delta" : 142271,
                        "size" : 2526006
                    },
                    "size" : 20370921
                },
                "label" : "20151029-113141F_20151029-113147I",
                "prior" : "20151029-113141F_20151029-113144D",
                "reference" : [
                    "20151029-113141F"
                ],
                "timestamp" : {
                    "start" : 1446118304,
                    "stop" : 1446118307
                },
                "type" : "incr"
            }
        ],
        "db" : [
            {
                "id" : "1",
                "system-id" : 6211030761463374229,
                "version" : "9.4"
            }
        ],
        "name" : "main",
        "status" : {
            "code" : 0,
            "message" : "ok"
        }
    }
]


Demo Complete!
