PgCon 2015 PgBackRest Demo

Setup the cluster and repo:

CREATE DB DIR: mkdir db

CREATE CLUSTER: initdb -D db -A trust
The files belonging to this database system will be owned by user "dsteele".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory db ... ok
creating subdirectories ... ok
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
creating configuration files ... ok
creating template1 database in db/base/1 ... ok
initializing pg_authid ... ok
initializing dependencies ... ok
creating system views ... ok
loading system objects' descriptions ... ok
creating collations ... ok
creating conversions ... ok
creating dictionaries ... ok
setting privileges on built-in objects ... ok
creating information schema ... ok
loading PL/pgSQL server-side language ... ok
vacuuming database template1 ... ok
copying template1 to template0 ... ok
copying template1 to postgres ... ok
syncing data to disk ... ok

Success. You can now start the database server using:

    postgres -D db
or
    pg_ctl -D db -l logfile start


START CLUSTER: pg_ctl start -o "-c port=5500 -c archive_mode=on -c wal_level=archive -c archive_command='/Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

CREATE TABLE: echo "create table test (message text)" | psql --port=5500 postgres
CREATE TABLE

SHOW CONF: cat /Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf
[global:command]
cmd-psql=psql -X --port=5500

[global:general]
repo-path=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/repo

[main]
db-path=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/db

CREATE REPO: mkdir repo

[press enter]

Do a full backup:

BACKUP TYPE=FULL: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --type=full backup

DB SIZE: du -sh db
 51M	db

SHOW BACKUP: ls -lah repo/backup/main
total 16
drwxr-xr-x+ 5 dsteele  staff   170B Jun 18 09:21 .
drwxr-xr-x+ 3 dsteele  staff   102B Jun 18 09:21 ..
drwxr-xr-x+ 4 dsteele  staff   136B Jun 18 09:21 20150618-092130F
-rw-r--r--+ 1 dsteele  staff   1.4K Jun 18 09:21 backup.info
lrwxr-xr-x  1 dsteele  staff    16B Jun 18 09:21 latest -> 20150618-092130F

BACKUP SIZE: du -sh repo/backup/main
4.9M	repo/backup/main

BACKUP INFO: more repo/backup/main/backup.info
[backrest]
backrest-checksum="5c8037491c461a04ac7b98552fe71459884cac58"
backrest-format=4
backrest-version="0.75"

[backup:current]
20150618-092130F={"backrest-format":4,"backrest-version":"0.75","backup-archive-start":"000000010000000000000002","backup-archive-stop":"000000010000000000000002","backup-info-repo-size":2411636,"backup-info-repo-size-delta":2411636,"backup-info-size":19885065,"backup-info-size-delta":19885065,"backup-timestamp-start":1434633685,"backup-timestamp-stop":1434633690,"backup-type":"full","db-id":1,"option-archive-check":true,"option-archive-copy":false,"option-compress":true,"option-hardlink":false,"option-start-stop":true}

[backup:history]
20150618-092130F={"backrest-format":4,"backrest-version":"0.75","backup-archive-start":"000000010000000000000002","backup-archive-stop":"000000010000000000000002","backup-info-repo-size":2411636,"backup-info-repo-size-delta":2411636,"backup-info-size":19885065,"backup-info-size-delta":19885065,"backup-timestamp-start":1434633685,"backup-timestamp-stop":1434633690,"backup-type":"full","db-id":1,"option-archive-check":true,"option-archive-copy":false,"option-compress":true,"option-hardlink":false,"option-start-stop":true}

[db]
db-catalog-version=201306121
db-control-version=937
db-id=1
db-system-id=6161704743069808637
db-version="9.3"

[db:history]
1={"db-catalog-version":201306121,"db-control-version":937,"db-system-id":6161704743069808637,"db-version":"9.3"}

[press enter]


SHOW ARCHIVE: ls -lah repo/archive/main/9.3-1/0000000100000000
total 3880
drwx------+ 5 dsteele  staff   170B Jun 18 09:21 .
drwx------+ 3 dsteele  staff   102B Jun 18 09:21 ..
-rw-------+ 1 dsteele  staff   1.9M Jun 18 09:21 000000010000000000000001-b94f5404b2d356a74ab5a78bc3d337bd685a620b.gz
-rw-------+ 1 dsteele  staff    16K Jun 18 09:21 000000010000000000000002-a4fdce14278ce9424268580eb0a09ef1a0bb76fe.gz
-rw-------+ 1 dsteele  staff   330B Jun 18 09:21 000000010000000000000002.00000028.backup

ARCHIVE SIZE: du -sh repo/archive/main/9.3-1
1.9M	repo/archive/main/9.3-1

ARCHIVE INFO: more repo/archive/main/archive.info
[backrest]
backrest-checksum="5515499c4387d0e5eb150ec953eb85a49921f3ae"
backrest-format=4
backrest-version="0.75"

[db]
db-id=1
db-system-id=6161704743069808637
db-version="9.3"

[db:history]
1={"db-id":6161704743069808637,"db-version":"9.3"}

[press enter]

Do a differential backup:

BACKUP TYPE=DIFF: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --type=diff backup

DB SIZE: du -sh db
 67M	db

SHOW BACKUP: ls -lah repo/backup/main
total 16
drwxr-xr-x+ 6 dsteele  staff   204B Jun 18 09:21 .
drwxr-xr-x+ 3 dsteele  staff   102B Jun 18 09:21 ..
drwxr-xr-x+ 4 dsteele  staff   136B Jun 18 09:21 20150618-092130F
drwxr-xr-x+ 4 dsteele  staff   136B Jun 18 09:21 20150618-092130F_20150618-092133D
-rw-r--r--+ 1 dsteele  staff   2.6K Jun 18 09:21 backup.info
lrwxr-xr-x  1 dsteele  staff    33B Jun 18 09:21 latest -> 20150618-092130F_20150618-092133D

BACKUP SIZE: du -sh repo/backup/main
5.1M	repo/backup/main

SHOW ARCHIVE: ls -lah repo/archive/main/9.3-1/0000000100000000
total 3928
drwx------+ 7 dsteele  staff   238B Jun 18 09:21 .
drwx------+ 3 dsteele  staff   102B Jun 18 09:21 ..
-rw-------+ 1 dsteele  staff   1.9M Jun 18 09:21 000000010000000000000001-b94f5404b2d356a74ab5a78bc3d337bd685a620b.gz
-rw-------+ 1 dsteele  staff    16K Jun 18 09:21 000000010000000000000002-a4fdce14278ce9424268580eb0a09ef1a0bb76fe.gz
-rw-------+ 1 dsteele  staff   330B Jun 18 09:21 000000010000000000000002.00000028.backup
-rw-------+ 1 dsteele  staff    16K Jun 18 09:21 000000010000000000000003-8eb016d8e0dd20323717650d961601308b031e47.gz
-rw-------+ 1 dsteele  staff   330B Jun 18 09:21 000000010000000000000003.00000028.backup

ARCHIVE SIZE: du -sh repo/archive/main/9.3-1
1.9M	repo/archive/main/9.3-1

[press enter]

Release time - let's backup and set a restore point so we can rollback if needed:

BACKUP TYPE=INCR: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --type=incr backup

SHOW BACKUP: ls -lah repo/backup/main
total 16
drwxr-xr-x+ 7 dsteele  staff   238B Jun 18 09:21 .
drwxr-xr-x+ 3 dsteele  staff   102B Jun 18 09:21 ..
drwxr-xr-x+ 4 dsteele  staff   136B Jun 18 09:21 20150618-092130F
drwxr-xr-x+ 4 dsteele  staff   136B Jun 18 09:21 20150618-092130F_20150618-092133D
drwxr-xr-x+ 4 dsteele  staff   136B Jun 18 09:21 20150618-092130F_20150618-092136I
-rw-r--r--+ 1 dsteele  staff   3.8K Jun 18 09:21 backup.info
lrwxr-xr-x  1 dsteele  staff    33B Jun 18 09:21 latest -> 20150618-092130F_20150618-092136I

INSERT BEFORE MESSAGE: echo "insert into test values ('before release')" | psql --port=5500 postgres
INSERT 0 1

CREATE RESTORE POINT: echo "select pg_create_restore_point('release')" | psql --port=5500 postgres
 pg_create_restore_point 
-------------------------
 0/5001FE0
(1 row)

DO THE RELEASE!

INSERT AFTER MESSAGE: echo "update test set message = 'after release'" | psql --port=5500 postgres
UPDATE 1

[press enter]

QA says the release is no good - please rollback:

RESTORE TYPE=NAME TARGET=release: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --type=name --target=release --delta restore
2015-06-18 09:21:36.607 T00  ERROR: [113]: unable to restore while Postgres is running

[press enter]

Forgot to stop the database - try again:

STOP CLUSTER: pg_ctl stop -D db -w -s -m fast

RESTORE TYPE=NAME TARGET=release: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --type=name --target=release --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/Users/dsteele/Documents/Code/backrest/bin/pg_backrest --config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf --stanza=main archive-get %f "%p"'
recovery_target_name = 'release'

START CLUSTER: pg_ctl start -o "-c port=5500 -c archive_mode=on -c wal_level=archive -c archive_command='/Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql --port=5500 postgres
    message     
----------------
 before release
(1 row)


SHOW NEW TIMELINE: ls -lah repo/archive/main/9.3-1
total 8
drwx------+  4 dsteele  staff   136B Jun 18 09:21 .
drwx------+  4 dsteele  staff   136B Jun 18 09:21 ..
drwx------+ 10 dsteele  staff   340B Jun 18 09:21 0000000100000000
-rw-------+  1 dsteele  staff    39B Jun 18 09:21 00000002.history

SHOW NEW TIMELINE INFO: more repo/archive/main/9.3-1/00000002.history
1	0/5001F78	at restore point "release"

INSERT AFTER MESSAGE: echo "update test set message = 'very important update'" | psql --port=5500 postgres
UPDATE 1

[press enter]

QA made a mistake, the release is good!  Please undo the rollback:

STOP CLUSTER: pg_ctl stop -D db -w -s -m fast

RESTORE TYPE=DEFAULT: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --delta restore

START CLUSTER: pg_ctl start -o "-c port=5500 -c archive_mode=on -c wal_level=archive -c archive_command='/Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql --port=5500 postgres
    message    
---------------
 after release
(1 row)


[press enter]

Uh oh - what about the 'very important update' that happened?.  Rollback the undo of the rollback:

STOP CLUSTER: pg_ctl stop -D db -w -s -m fast

RESTORE TYPE=DEFAULT TIMELINE=2: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --target-timeline=2 --delta restore

START CLUSTER: pg_ctl start -o "-c port=5500 -c archive_mode=on -c wal_level=archive -c archive_command='/Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql --port=5500 postgres
        message        
-----------------------
 very important update
(1 row)


[press enter]


INFO OUTPUT=TEXT: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main info
stanza main
    status: ok
    oldest backup label: 20150618-092130F
    oldest backup timestamp: 2015-06-18 09:21:52
    latest backup label: 20150618-092130F_20150618-092136I
    latest backup timestamp: 2015-06-18 09:21:52

[press enter]


INFO OUTPUT=JSON: /Users/dsteele/Documents/Code/backrest/bin/pg_backrest "--config=/Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf" --stanza=main --output=json info
[
    {
        "backup" : [
            {
                "archive" : {
                    "start" : "000000010000000000000002",
                    "stop" : "000000010000000000000002"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.75"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 19885065,
                    "repository" : {
                        "delta" : 2411636,
                        "size" : 2411636
                    },
                    "size" : 19885065
                },
                "label" : "20150618-092130F",
                "prior" : null,
                "reference" : null,
                "timestamp" : {
                    "start" : 1434633685,
                    "stop" : 1434633690
                },
                "type" : "full"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000003",
                    "stop" : "000000010000000000000003"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.75"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8426,
                    "repository" : {
                        "delta" : 139647,
                        "size" : 2435334
                    },
                    "size" : 19885065
                },
                "label" : "20150618-092130F_20150618-092133D",
                "prior" : "20150618-092130F",
                "reference" : [
                    "20150618-092130F"
                ],
                "timestamp" : {
                    "start" : 1434633690,
                    "stop" : 1434633693
                },
                "type" : "diff"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000004",
                    "stop" : "000000010000000000000004"
                },
                "backrest" : {
                    "format" : 4,
                    "version" : "0.75"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8426,
                    "repository" : {
                        "delta" : 139661,
                        "size" : 2435348
                    },
                    "size" : 19885065
                },
                "label" : "20150618-092130F_20150618-092136I",
                "prior" : "20150618-092130F_20150618-092133D",
                "reference" : [
                    "20150618-092130F"
                ],
                "timestamp" : {
                    "start" : 1434633693,
                    "stop" : 1434633696
                },
                "type" : "incr"
            }
        ],
        "db" : [
            {
                "id" : "1",
                "system-id" : 6161704743069808637,
                "version" : "9.3"
            }
        ],
        "name" : "main",
        "status" : {
            "code" : 0,
            "message" : "ok"
        }
    }
]

[press enter]

Stop the cluster:

STOP CLUSTER: pg_ctl stop -D db -w -s -m fast

DELETE CONF: rm /Users/dsteele/Documents/Conference/HeavyDutyPgBackRest/demo/pg_backrest.conf

Demo Complete!
