pgBackRest Demo
===============

---------------------------
Setup the cluster and repo:
---------------------------

CREATE DB DIR: mkdir db

CREATE CLUSTER: /usr/lib/postgresql/9.5/bin/initdb -D db -A trust > /dev/null

START CLUSTER: /usr/lib/postgresql/9.5/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pgbackrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

CREATE TABLE: echo "create table test (message text)" | psql postgres
CREATE TABLE

SHOW CONF: cat /etc/pgbackrest.conf
[global]
repo-path=/home/vagrant/repo
retention-full=4

[main]
db-path=/home/vagrant/db

CREATE REPO: mkdir repo

----------------------
Perform a full backup:
----------------------

BACKUP TYPE=FULL: pgbackrest --stanza=main --type=full backup

DB SIZE: du -sh db
53M	db

SHOW BACKUP: ls -lah repo/backup/main
total 20K
drwxr-x--- 4 vagrant vagrant 4.0K Sep 13 22:24 .
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 ..
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 20160913-222441F
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 backup.history
-rw-r----- 1 vagrant vagrant  928 Sep 13 22:24 backup.info
lrwxrwxrwx 1 vagrant vagrant   16 Sep 13 22:24 latest -> 20160913-222441F

BACKUP SIZE: du -sh repo/backup/main
5.7M	repo/backup/main

-----------------------------------
Show archive after the full backup:
-----------------------------------

SHOW ARCHIVE: ls -lah repo/archive/main/9.5-1/0000000100000000
total 40K
drwxr-x--- 2 vagrant vagrant 4.0K Sep 13 22:24 .
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 ..
-rw-r----- 1 vagrant vagrant  332 Sep 13 22:24 000000010000000000000002.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Sep 13 22:24 000000010000000000000002-5597785ad9efe21ec50d13822b91758ad8343774.gz

ARCHIVE SIZE: du -sh repo/archive/main/9.5-1
40K	repo/archive/main/9.5-1

------------------------------
Perform a differential backup:
------------------------------

BACKUP TYPE=DIFF: pgbackrest --stanza=main --type=diff backup

DB SIZE: du -sh db
69M	db

SHOW BACKUP: ls -lah repo/backup/main
total 24K
drwxr-x--- 5 vagrant vagrant 4.0K Sep 13 22:24 .
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 ..
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 20160913-222441F
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 20160913-222441F_20160913-222444D
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 backup.history
-rw-r----- 1 vagrant vagrant 1.6K Sep 13 22:24 backup.info
lrwxrwxrwx 1 vagrant vagrant   33 Sep 13 22:24 latest -> 20160913-222441F_20160913-222444D

BACKUP SIZE: du -sh repo/backup/main
5.9M	repo/backup/main

-------------------------------------------
Show archive after the differential backup:
-------------------------------------------

SHOW ARCHIVE: ls -lah repo/archive/main/9.5-1/0000000100000000
total 72K
drwxr-x--- 2 vagrant vagrant 4.0K Sep 13 22:24 .
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 ..
-rw-r----- 1 vagrant vagrant  332 Sep 13 22:24 000000010000000000000002.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Sep 13 22:24 000000010000000000000002-5597785ad9efe21ec50d13822b91758ad8343774.gz
-rw-r----- 1 vagrant vagrant  332 Sep 13 22:24 000000010000000000000003.00000028.backup
-rw-r----- 1 vagrant vagrant  27K Sep 13 22:24 000000010000000000000003-cfd6a39d71991963f92eadd7c043740da8e41f13.gz

ARCHIVE SIZE: du -sh repo/archive/main/9.5-1
72K	repo/archive/main/9.5-1

-----------------------------
Release time - take a backup:
-----------------------------

BACKUP TYPE=INCR: pgbackrest --stanza=main --type=incr backup

SHOW BACKUP: ls -lah repo/backup/main
total 28K
drwxr-x--- 6 vagrant vagrant 4.0K Sep 13 22:24 .
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 ..
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 20160913-222441F
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 20160913-222441F_20160913-222444D
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 20160913-222441F_20160913-222447I
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 backup.history
-rw-r----- 1 vagrant vagrant 2.2K Sep 13 22:24 backup.info
lrwxrwxrwx 1 vagrant vagrant   33 Sep 13 22:24 latest -> 20160913-222441F_20160913-222447I

-----------------------------------
Release time - set a restore point:
-----------------------------------

INSERT BEFORE MESSAGE: echo "insert into test values ('before release')" | psql postgres
INSERT 0 1

CREATE RESTORE POINT: echo "select pg_create_restore_point('release')" | psql postgres
 pg_create_restore_point 
-------------------------
 0/5000100
(1 row)


--------------------
Perform the release:
--------------------

INSERT AFTER MESSAGE: echo "update test set message = 'after release'" | psql postgres
UPDATE 1

-------------------------------------------------
QA says the release is no good - please rollback:
-------------------------------------------------

RESTORE TYPE=NAME TARGET=release: pgbackrest --stanza=main --type=name --target=release --delta restore
2016-09-13 22:24:48.232 P00  ERROR: [113]: unable to restore while Postgres is running

----------------------------------------
Forgot to stop the database - try again:
----------------------------------------

STOP CLUSTER: /usr/lib/postgresql/9.5/bin/pg_ctl stop -D db -w -s -m fast > /dev/null

RESTORE TYPE=NAME TARGET=release: pgbackrest --stanza=main --type=name --target=release --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pgbackrest --stanza=main archive-get %f "%p"'
recovery_target_name = 'release'

-------------------------------------------
Start the database and verify the recovery:
-------------------------------------------

START CLUSTER: /usr/lib/postgresql/9.5/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pgbackrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
    message     
----------------
 before release
(1 row)


SHOW NEW TIMELINE: ls -lah repo/archive/main/9.5-1
total 16K
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 .
drwxr-x--- 3 vagrant vagrant 4.0K Sep 13 22:24 ..
drwxr-x--- 2 vagrant vagrant 4.0K Sep 13 22:24 0000000100000000
-rw-r----- 1 vagrant vagrant   39 Sep 13 22:24 00000002.history

-------------------------------------------------------------
App is started and important data is written to the database:
-------------------------------------------------------------

INSERT AFTER MESSAGE: echo "update test set message = 'very important update'" | psql postgres
UPDATE 1

------------------------------------------------------------------
QA made a mistake, the release is good!  Please undo the rollback:
------------------------------------------------------------------

STOP CLUSTER: /usr/lib/postgresql/9.5/bin/pg_ctl stop -D db -w -s -m fast > /dev/null

RESTORE TYPE=DEFAULT: pgbackrest --stanza=main --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pgbackrest --stanza=main archive-get %f "%p"'

START CLUSTER: /usr/lib/postgresql/9.5/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pgbackrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
    message    
---------------
 after release
(1 row)


--------------------------------------------------------------
Uh oh - what about the 'very important update' that happened?:
--------------------------------------------------------------

STOP CLUSTER: /usr/lib/postgresql/9.5/bin/pg_ctl stop -D db -w -s -m fast > /dev/null

RESTORE TYPE=DEFAULT TIMELINE=2: pgbackrest --stanza=main --target-timeline=2 --delta restore

SHOW RECOVERY.CONF: more db/recovery.conf
restore_command = '/usr/bin/pgbackrest --stanza=main archive-get %f "%p"'
recovery_target_timeline = '2'

START CLUSTER: /usr/lib/postgresql/9.5/bin/pg_ctl start -o "-c archive_mode=on -c wal_level=archive -c archive_command='pgbackrest --stanza=main archive-push %p'" -D db -l db/postgresql.log -w -s

GET MESSAGE: echo "select message from test" | psql postgres
        message        
-----------------------
 very important update
(1 row)


----------------
Show basic info:
----------------

INFO OUTPUT=TEXT: pgbackrest --stanza=main info
stanza: main
    status: ok

    full backup: 20160913-222441F
        start / stop timestamp: 2016-09-13 22:24:30 / 2016-09-13 22:24:41
        database size: 20.7MB, backup size: 20.7MB
        repository size: 2.4MB, repository backup size: 2.4MB

    diff backup: 20160913-222441F_20160913-222444D
        start / stop timestamp: 2016-09-13 22:24:41 / 2016-09-13 22:24:44
        database size: 20.7MB, backup size: 8.2KB
        repository size: 2.4MB, repository backup size: 343B
        backup reference list: 20160913-222441F

    incr backup: 20160913-222441F_20160913-222447I
        start / stop timestamp: 2016-09-13 22:24:45 / 2016-09-13 22:24:47
        database size: 20.7MB, backup size: 8.2KB
        repository size: 2.4MB, repository backup size: 342B
        backup reference list: 20160913-222441F

--------------------------
Show exhaustive JSON info:
--------------------------

INFO OUTPUT=JSON: pgbackrest --stanza=main --output=json info
[
    {
        "backup" : [
            {
                "archive" : {
                    "start" : "000000010000000000000002",
                    "stop" : "000000010000000000000002"
                },
                "backrest" : {
                    "format" : 5,
                    "version" : "1.07"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 21762273,
                    "repository" : {
                        "delta" : 2517804,
                        "size" : 2517804
                    },
                    "size" : 21762273
                },
                "label" : "20160913-222441F",
                "prior" : null,
                "reference" : null,
                "timestamp" : {
                    "start" : 1473805470,
                    "stop" : 1473805481
                },
                "type" : "full"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000003",
                    "stop" : "000000010000000000000003"
                },
                "backrest" : {
                    "format" : 5,
                    "version" : "1.07"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8428,
                    "repository" : {
                        "delta" : 343,
                        "size" : 2517801
                    },
                    "size" : 21762273
                },
                "label" : "20160913-222441F_20160913-222444D",
                "prior" : "20160913-222441F",
                "reference" : [
                    "20160913-222441F"
                ],
                "timestamp" : {
                    "start" : 1473805481,
                    "stop" : 1473805484
                },
                "type" : "diff"
            },
            {
                "archive" : {
                    "start" : "000000010000000000000004",
                    "stop" : "000000010000000000000004"
                },
                "backrest" : {
                    "format" : 5,
                    "version" : "1.07"
                },
                "database" : {
                    "id" : 1
                },
                "info" : {
                    "delta" : 8428,
                    "repository" : {
                        "delta" : 342,
                        "size" : 2517800
                    },
                    "size" : 21762273
                },
                "label" : "20160913-222441F_20160913-222447I",
                "prior" : "20160913-222441F_20160913-222444D",
                "reference" : [
                    "20160913-222441F"
                ],
                "timestamp" : {
                    "start" : 1473805485,
                    "stop" : 1473805487
                },
                "type" : "incr"
            }
        ],
        "db" : [
            {
                "id" : "1",
                "system-id" : 6329946283862958520,
                "version" : "9.5"
            }
        ],
        "name" : "main",
        "status" : {
            "code" : 0,
            "message" : "ok"
        }
    }
]


Demo Complete!
